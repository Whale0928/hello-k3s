# Kubernetes 매니페스트 이해하기

## 매니페스트란?

**매니페스트(Manifest)**는 쿠버네티스에게 "무엇을 어떻게 실행해줘"라고 요청하는 **설정 파일**입니다.

```
생각해보세요:
- 이력서 = 나를 설명하는 문서
- 레시피 = 요리를 설명하는 문서  
- 매니페스트 = 쿠버네티스 리소스를 설명하는 문서
```

## 왜 매니페스트가 필요한가?

### 수동 명령어의 한계

```bash
# 명령어로 nginx 실행
kubectl run nginx --image=nginx --port=80

# 문제점:
# 1. 복잡한 설정 불가능
# 2. 재현하기 어려움
# 3. 버전 관리 불가능
# 4. 팀원과 공유 어려움
```

### 매니페스트의 장점

```yaml
# nginx.yaml 파일로 관리
apiVersion: v1
kind: Pod
metadata:
  name: nginx
spec:
  containers:
  - name: nginx
    image: nginx:1.21
    ports:
    - containerPort: 80

# 장점:
# 1. Git으로 버전 관리 ✓
# 2. 팀원과 공유 가능 ✓  
# 3. 복잡한 설정 가능 ✓
# 4. 언제든 재현 가능 ✓
```

## YAML 형식 이해하기

### YAML이란?

**YAML = "YAML Ain't Markup Language"**
- 사람이 읽기 쉬운 데이터 형식
- JSON보다 간결하고 읽기 쉬움
- 들여쓰기로 구조 표현 (Python과 유사)

### YAML 기본 문법

```yaml
# 주석은 # 으로 시작

# 키-값 쌍
name: nginx
version: 1.21

# 리스트 (배열)
ports:
  - 80
  - 443
  
# 또는
ports: [80, 443]

# 중첩된 구조
container:
  name: my-app
  image: nginx:1.21
  ports:
    - containerPort: 80
    - containerPort: 443

# 텍스트 블록
description: |
  이것은 여러 줄의
  텍스트를 그대로
  유지합니다.
```

### 들여쓰기 규칙

```yaml
# ✅ 올바른 들여쓰기 (스페이스 2칸)
spec:
  containers:
    - name: nginx
      image: nginx

# ❌ 잘못된 들여쓰기 (탭 사용 금지!)
spec:
	containers:  # 탭 사용 X
    - name: nginx
```

## 매니페스트의 기본 구조

모든 쿠버네티스 매니페스트는 4개의 필수 필드를 가집니다:

```yaml
apiVersion: v1           # API 버전
kind: Pod               # 리소스 종류
metadata:               # 메타데이터 (이름, 라벨 등)
  name: my-pod
spec:                   # 상세 명세
  # 실제 설정 내용
```

### 1. apiVersion (API 버전)

```yaml
apiVersion: v1          # 기본 리소스 (Pod, Service)
apiVersion: apps/v1     # Deployment, StatefulSet
apiVersion: batch/v1    # Job, CronJob
```

어떤 버전을 써야 하나요?
- 걱정 마세요! 각 리소스마다 정해진 버전이 있습니다
- 문서나 예제를 참고하면 됩니다

### 2. kind (리소스 종류)

```yaml
kind: Pod               # 컨테이너 실행 단위
kind: Service           # 네트워크 접근점
kind: Deployment        # 앱 배포 관리
kind: ConfigMap         # 설정 저장
```

### 3. metadata (메타데이터)

```yaml
metadata:
  name: my-app          # 리소스 이름 (필수)
  namespace: default    # 네임스페이스
  labels:               # 라벨 (태그)
    app: nginx
    env: production
```

### 4. spec (상세 명세)

리소스마다 다른 내용이 들어갑니다:

```yaml
# Pod의 spec
spec:
  containers:
  - name: nginx
    image: nginx:1.21

# Service의 spec  
spec:
  selector:
    app: nginx
  ports:
  - port: 80
```

## 첫 번째 매니페스트 작성하기

### Step 1: 가장 간단한 Pod

```yaml
# simple-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: my-first-pod
spec:
  containers:
  - name: nginx
    image: nginx
```

실행하기:
```bash
kubectl apply -f simple-pod.yaml
kubectl get pods
kubectl delete -f simple-pod.yaml
```

### Step 2: 라벨 추가

```yaml
# pod-with-labels.yaml
apiVersion: v1
kind: Pod
metadata:
  name: my-pod
  labels:
    app: web
    environment: dev
spec:
  containers:
  - name: nginx
    image: nginx
```

라벨로 검색:
```bash
kubectl get pods -l app=web
kubectl get pods -l environment=dev
```

### Step 3: 여러 컨테이너 Pod

```yaml
# multi-container-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: multi-container
spec:
  containers:
  - name: nginx
    image: nginx
    ports:
    - containerPort: 80
  - name: redis
    image: redis
    ports:
    - containerPort: 6379
```

## 자주 사용하는 리소스 종류

### Pod - 가장 작은 단위

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx-pod
spec:
  containers:
  - name: nginx
    image: nginx
```

**언제 사용?**
- 테스트나 디버깅
- 실제로는 잘 안 씀 (Deployment 사용)

### Deployment - 앱 배포 관리

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
spec:
  replicas: 3           # 3개 복사본 실행
  selector:
    matchLabels:
      app: nginx
  template:             # Pod 템플릿
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx
```

**언제 사용?**
- 대부분의 앱 배포
- 자동 복구, 롤링 업데이트 필요할 때

### Service - 네트워크 접근점

```yaml
apiVersion: v1
kind: Service
metadata:
  name: nginx-service
spec:
  selector:
    app: nginx          # app=nginx 라벨의 Pod 연결
  ports:
  - port: 80
    targetPort: 80
```

**언제 사용?**
- Pod에 접근할 고정 주소가 필요할 때
- 로드 밸런싱이 필요할 때

### ConfigMap - 설정 저장

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
data:
  database_url: "localhost:3306"
  app_mode: "production"
```

**언제 사용?**
- 환경 변수 관리
- 설정 파일 관리

## 매니페스트 작성 팁

### 1. 작은 것부터 시작

```yaml
# ❌ 처음부터 복잡하게
apiVersion: apps/v1
kind: Deployment
metadata:
  name: complex-app
  annotations:
    kubernetes.io/change-cause: "version 2.0"
spec:
  replicas: 5
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 2
      maxUnavailable: 1
  # ... 100줄 더...

# ✅ 간단하게 시작
apiVersion: v1
kind: Pod
metadata:
  name: simple-app
spec:
  containers:
  - name: app
    image: myapp:1.0
```

### 2. 들여쓰기 주의

```yaml
# VS Code 설정 (.vscode/settings.json)
{
  "yaml.format.enable": true,
  "yaml.format.singleQuote": true,
  "editor.insertSpaces": true,
  "editor.tabSize": 2
}
```

### 3. 검증 먼저

```bash
# 실행 전 검증
kubectl apply --dry-run=client -f my-manifest.yaml

# YAML 문법 검사
kubectl apply --validate=true -f my-manifest.yaml
```

### 4. 한 파일에 여러 리소스

```yaml
# app.yaml - 여러 리소스를 --- 로 구분
apiVersion: v1
kind: Pod
metadata:
  name: my-pod
spec:
  containers:
  - name: nginx
    image: nginx
---
apiVersion: v1
kind: Service
metadata:
  name: my-service
spec:
  selector:
    app: nginx
  ports:
  - port: 80
```

## 자주 하는 실수와 해결법

### 1. 들여쓰기 오류

```yaml
# ❌ 에러: 들여쓰기 불일치
spec:
  containers:
   - name: nginx    # 3칸 들여쓰기
    image: nginx    # 4칸 들여쓰기

# ✅ 수정: 일관된 들여쓰기
spec:
  containers:
  - name: nginx     # 2칸
    image: nginx    # 4칸 (리스트 아이템 내부)
```

### 2. apiVersion 오류

```bash
# 에러 메시지
error validating data: ValidationError(Deployment): 
unknown field "apiVersion" in io.k8s.api.apps.v1.Deployment

# 해결: 올바른 apiVersion 확인
kubectl api-resources | grep Deployment
# NAME         SHORTNAMES   APIVERSION   NAMESPACED   KIND
# deployments  deploy       apps/v1      true         Deployment
```

### 3. 필수 필드 누락

```yaml
# ❌ 에러: selector 누락
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
spec:
  replicas: 3
  template:
    spec:
      containers:
      - name: nginx
        image: nginx

# ✅ 수정: selector 추가
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
spec:
  replicas: 3
  selector:           # 필수!
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:         # selector와 일치해야 함
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx
```

## 실습: Spring Boot 앱 매니페스트

```yaml
# spring-boot-app.yaml
apiVersion: v1
kind: Pod
metadata:
  name: spring-boot-app
  labels:
    app: spring-boot
    tier: backend
spec:
  containers:
  - name: app
    image: eclipse-temurin:17-jre
    command: ["java", "-jar", "/app.jar"]
    ports:
    - containerPort: 8080
    env:
    - name: SPRING_PROFILES_ACTIVE
      value: "production"
    - name: SERVER_PORT
      value: "8080"
```

## 매니페스트 명령어 모음

```bash
# 적용 (생성/업데이트)
kubectl apply -f manifest.yaml

# 삭제
kubectl delete -f manifest.yaml

# 확인 (실제 적용 안 함)
kubectl apply --dry-run=client -f manifest.yaml

# 차이점 확인
kubectl diff -f manifest.yaml

# 실행 중인 리소스를 YAML로 보기
kubectl get pod my-pod -o yaml

# 실행 중인 리소스 수정
kubectl edit pod my-pod

# 여러 파일 한 번에 적용
kubectl apply -f ./manifests/

# URL에서 직접 적용
kubectl apply -f https://example.com/manifest.yaml
```

## 다음 단계

매니페스트의 기본을 이해했다면:
1. **실제 K3s 설치** (o5 문서)
2. **첫 Pod 배포 실습**
3. **Deployment로 앱 관리**
4. **Service로 네트워크 구성**

## 요약

- **매니페스트 = 쿠버네티스 설정 파일 (YAML)**
- **4개 필수 필드**: apiVersion, kind, metadata, spec
- **들여쓰기 중요**: 스페이스 2칸 or 4칸 (일관성)
- **작게 시작**: Pod → Deployment → Service
- **Git으로 관리**: 버전 관리와 협업의 핵심

매니페스트는 쿠버네티스의 **언어**입니다. 처음엔 어색하지만, 몇 번 작성하다 보면 자연스러워집니다!