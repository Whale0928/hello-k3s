# 마스터 노드 (Control Plane) 이해하기

## 마스터 노드란?

마스터 노드는 Kubernetes 클러스터의 **두뇌** 역할을 합니다. 전체 클러스터를 관리하고 제어하는 중앙 컨트롤 타워로, 모든 의사결정이 여기서 이루어집니다.

```
비유: 
마스터 노드 = 공항 관제탑
워커 노드 = 활주로와 게이트
파드 = 비행기

관제탑이 모든 비행기의 이착륙을 지휘하듯
마스터 노드가 모든 파드의 실행을 관리
```

---

## 마스터 노드의 구성 요소

마스터 노드는 여러 핵심 컴포넌트로 구성되어 있으며, 각각 고유한 역할을 담당합니다.

```
┌──────────────────────────────────────┐
│         Master Node (Control Plane)   │
├──────────────────────────────────────┤
│                                      │
│  ┌────────────┐    ┌──────────────┐  │
│  │ API Server │───▶│     etcd     │  │
│  └────────────┘    └──────────────┘  │
│         │                            │
│  ┌──────▼─────┐    ┌──────────────┐  │
│  │ Scheduler  │    │  Controller  │  │
│  └────────────┘    │   Manager    │  │
│                    └──────────────┘  │
└──────────────────────────────────────┘
```

---

## API Server - 모든 요청의 관문

### 역할과 책임

API Server는 클러스터의 **정문** 역할을 합니다. 모든 요청은 반드시 API Server를 거쳐야 합니다.

**주요 기능:**
- REST API 엔드포인트 제공
- 인증(Authentication) 처리
- 권한 검증(Authorization)
- 요청 유효성 검사
- etcd와의 유일한 통신 창구

### 동작 과정

```
1. kubectl 명령 실행
       ↓
2. API Server가 요청 수신
       ↓
3. 사용자 인증 확인
       ↓
4. 권한 검증 (RBAC)
       ↓
5. 요청 유효성 검사
       ↓
6. etcd에 저장 또는 조회
       ↓
7. 응답 반환
```

### 실제 예시

```bash
# kubectl 명령을 실행하면
kubectl create deployment nginx --image=nginx

# 실제로는 API Server에 REST 요청
POST https://cluster-ip:6443/apis/apps/v1/namespaces/default/deployments
{
  "metadata": {"name": "nginx"},
  "spec": {"replicas": 1, "template": {...}}
}
```

---

## Scheduler - 파드 배치 결정자

### 역할과 책임

Scheduler는 새로운 파드를 **어느 노드에 배치할지 결정**하는 컴포넌트입니다.

**주요 기능:**
- 노드 리소스 상태 모니터링
- 파드 요구사항 분석
- 최적 노드 선택
- 배치 결정 (실제 실행은 kubelet이 담당)

### 스케줄링 과정

```
1. 새 파드 생성 요청 감지
       ↓
2. 필터링 단계
   - 리소스 충분한가?
   - 노드 셀렉터 일치하는가?
   - 테인트/톨러레이션 확인
       ↓
3. 점수 계산 단계
   - 리소스 균형도
   - 파드 분산도
   - 이미지 존재 여부
       ↓
4. 최고 점수 노드 선택
       ↓
5. 파드를 해당 노드에 바인딩
```

### 스케줄링 예시

```
현재 클러스터 상태:
┌─────────────┬─────────────┬─────────────┐
│   Node 1    │   Node 2    │   Node 3    │
│ CPU: 80%    │ CPU: 30%    │ CPU: 50%    │
│ RAM: 70%    │ RAM: 40%    │ RAM: 90%    │
└─────────────┴─────────────┴─────────────┘

새 파드 요구사항:
- CPU: 500m
- Memory: 1Gi

스케줄러 결정: Node 2 선택 (리소스 여유 많음)
```

---

## Controller Manager - 상태 관리자

### 역할과 책임

Controller Manager는 여러 컨트롤러를 실행하여 **클러스터의 현재 상태를 원하는 상태로 유지**합니다.

### 주요 컨트롤러들

**1. Deployment Controller**
```
원하는 상태: nginx 파드 3개
현재 상태: nginx 파드 2개 (1개 죽음)
동작: 새 파드 1개 생성
```

**2. ReplicaSet Controller**
```
역할: 지정된 수의 파드 복제본 유지
예: replicas=3이면 항상 3개 유지
```

**3. Node Controller**
```
역할: 노드 상태 모니터링
- 노드 다운 감지
- 파드 재스케줄링 트리거
- 노드 상태 업데이트
```

**4. Service Controller**
```
역할: 로드밸런서 및 엔드포인트 관리
- 클라우드 로드밸런서 생성/삭제
- 서비스 엔드포인트 업데이트
```

### 컨트롤 루프

```
무한 반복:
┌─────────────────┐
│ 현재 상태 확인   │
└────────┬────────┘
         ↓
┌─────────────────┐
│ 원하는 상태와    │
│ 비교            │
└────────┬────────┘
         ↓
┌─────────────────┐
│ 차이가 있으면    │
│ 조정 작업 수행   │
└────────┬────────┘
         ↓
      (반복)
```

---

## etcd - 클러스터 데이터베이스

### 역할과 책임

etcd는 분산 키-값 저장소로, **클러스터의 모든 데이터를 저장**합니다.

**저장되는 데이터:**
- 클러스터 설정
- 파드, 서비스, 컨피그맵 정보
- 시크릿 데이터
- 네트워크 정책
- RBAC 규칙

### 특징

```
┌──────────────────────────────┐
│          etcd 특징            │
├──────────────────────────────┤
│ • 분산 저장 (고가용성)         │
│ • 강한 일관성 보장             │
│ • watch 기능 (변경 감지)       │
│ • 버전 관리 (히스토리)         │
│ • 암호화 지원                 │
└──────────────────────────────┘
```

### 데이터 구조 예시

```
/registry/pods/default/nginx-pod
/registry/services/default/nginx-service
/registry/deployments/default/nginx-deployment
/registry/configmaps/default/app-config
/registry/secrets/default/db-password
```

---

## 마스터 노드 고가용성 (HA)

### 단일 마스터의 문제점

```
┌─────────────┐
│ Single Master│ ← 장애 발생 시
└─────────────┘   전체 클러스터 마비
```

### HA 구성 (3개 이상 홀수)

```
┌──────────────────────────────────┐
│      HA Master Nodes (3개)       │
├──────────────────────────────────┤
│ Master1   Master2   Master3      │
│   Active    Active    Active     │
│                                  │
│  etcd 클러스터 (Raft 합의)        │
│  과반수 살아있으면 정상 동작       │
└──────────────────────────────────┘
```

**왜 홀수 개?**
- 2개: 1개 죽으면 과반수 불가
- 3개: 1개 죽어도 2개로 과반수
- 4개: 3개와 내결함성 동일 (낭비)
- 5개: 2개까지 죽어도 OK

---

## 마스터 노드 리소스 요구사항

### 최소 사양 (개발/테스트)

```
CPU: 2 cores
Memory: 2GB
Disk: 20GB
Network: 1Gbps

예: 미니PC, 소규모 VM
```

### 권장 사양 (프로덕션)

```
CPU: 4-8 cores
Memory: 8-16GB
Disk: 100GB SSD
Network: 10Gbps

예: 전용 서버, 클라우드 인스턴스
```

### 대규모 클러스터

```
노드 수: 1000+
파드 수: 30000+

CPU: 16+ cores
Memory: 32GB+
Disk: 500GB+ SSD
etcd: 별도 전용 서버
```

---

## 마스터 노드 보안

### 접근 제어

**1. API Server 인증**
```
- 인증서 기반 (TLS)
- 토큰 기반 (Bearer Token)
- OIDC (OAuth2)
- Webhook
```

**2. RBAC 권한 관리**
```yaml
# 읽기 전용 역할
kind: Role
rules:
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list"]
```

### 네트워크 보안

```
방화벽 규칙:
6443/tcp  - API Server (필수)
2379/tcp  - etcd client (마스터 간)
2380/tcp  - etcd peer (마스터 간)
10250/tcp - kubelet API
10251/tcp - scheduler
10252/tcp - controller manager
```

---

## 마스터 노드 모니터링

### 핵심 메트릭

**API Server**
```
- 요청 처리 시간
- 요청 성공/실패율
- 동시 연결 수
- 인증 실패 횟수
```

**etcd**
```
- 읽기/쓰기 지연시간
- 리더 선출 횟수
- 데이터베이스 크기
- 멤버 상태
```

**Scheduler**
```
- 스케줄링 지연시간
- 스케줄링 실패율
- 대기 중인 파드 수
```

### 모니터링 명령어

```bash
# 컴포넌트 상태 확인
kubectl get componentstatuses

# etcd 상태
etcdctl endpoint health

# API Server 메트릭
kubectl get --raw /metrics

# 마스터 노드 리소스
kubectl top node <master-node-name>
```

---

## K3s의 마스터 노드

### K3s 특징

K3s는 마스터 노드 컴포넌트를 **단일 바이너리**로 통합했습니다.

```
일반 K8s:
┌──────────┬──────────┬──────────┬──────────┐
│ kube-api │ scheduler│controller│   etcd   │
│ (프로세스)│ (프로세스)│ (프로세스)│ (프로세스)│
└──────────┴──────────┴──────────┴──────────┘

K3s:
┌─────────────────────────────────────────┐
│           k3s server (단일 프로세스)       │
│  내장: API, Scheduler, Controller, SQLite│
└─────────────────────────────────────────┘
```

### K3s 마스터 설치 미리보기

```bash
# 간단한 설치 (다음 문서에서 자세히)
curl -sfL https://get.k3s.io | sh -

# 마스터 + 워커 역할 동시 수행
# 미니PC에 적합한 구성
```

---

## 트러블슈팅 체크리스트

### 마스터 노드 문제 진단

**1. API Server 접근 불가**
```bash
# 서비스 상태 확인
systemctl status kube-apiserver

# 포트 확인
netstat -tlnp | grep 6443

# 인증서 확인
openssl x509 -in /etc/kubernetes/pki/apiserver.crt -text
```

**2. 스케줄링 안 됨**
```bash
# 스케줄러 로그
kubectl logs -n kube-system kube-scheduler-<node>

# Pending 파드 확인
kubectl get pods --field-selector status.phase=Pending
```

**3. etcd 문제**
```bash
# etcd 멤버 상태
etcdctl member list

# etcd 로그
journalctl -u etcd
```

---

## 요약

마스터 노드(Control Plane)는 Kubernetes 클러스터의 두뇌입니다.

**핵심 컴포넌트:**
- **API Server**: 모든 요청의 관문
- **Scheduler**: 파드 배치 결정
- **Controller Manager**: 상태 관리
- **etcd**: 데이터 저장소

**중요 포인트:**
- 모든 관리 작업은 마스터 노드에서 처리
- 고가용성을 위해 홀수 개(3, 5) 구성
- K3s는 이 모든 걸 단일 바이너리로 제공

다음 문서에서는 실제로 애플리케이션이 실행되는 **워커 노드**에 대해 알아보겠습니다.